// Prisma schema for JelantahGO

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String?  @unique // OPSIONAL untuk customer
  password        String
  name            String   // WAJIB
  phone           String   @unique // WAJIB dan unique
  address         String   // WAJIB - Alamat Lengkap
  kelurahan       String?  // OPSIONAL
  kecamatan       String?  // OPSIONAL
  kota            String   // WAJIB
  latitude        Float?   // WAJIB untuk customer, opsional untuk role lain
  longitude       Float?   // WAJIB untuk customer, opsional untuk role lain
  shareLocationUrl String? // OPSIONAL - Google Maps URL untuk kemudahan kurir
  role            String   @default("CUSTOMER") // ADMIN, CUSTOMER, COURIER, WAREHOUSE
  isActive        Boolean  @default(true)
  referralCode    String   @unique
  referredById    String?  // OPSIONAL - Di referensikan oleh
  lastOrderDate   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  referredBy      User?    @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals       User[]   @relation("Referrals")
  
  pickupsAsCustomer  Pickup[]  @relation("CustomerPickups")
  pickupsAsCourier   Pickup[]  @relation("CourierPickups")
  warehouseEntries   Pickup[]  @relation("WarehousePickups")
  bills              Bill[]
  commissions        Commission[]
  notifications      Notification[]
  sentMessages       Message[] @relation("SentMessages")
  receivedMessages   Message[] @relation("ReceivedMessages")
}

model Pickup {
  id               String   @id @default(uuid())
  customerId       String
  courierId        String?
  warehouseId      String?
  status           String   @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED
  scheduledDate    DateTime
  actualDate       DateTime?
  volume           Float    // in liters (estimated)
  actualVolume     Float?   // actual liters collected at location
  pricePerLiter    Float
  totalPrice       Float
  courierFee       Float    @default(0)
  affiliateFee     Float    @default(0)
  notes            String?
  photoProof       String?  // URL/path to pickup photo proof
  latitude         Float?
  longitude        Float?
  bankName         String?  // Customer's bank name
  accountName      String?  // Customer's account holder name
  accountNumber    String?  // Customer's account number
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  customer         User     @relation("CustomerPickups", fields: [customerId], references: [id])
  courier          User?    @relation("CourierPickups", fields: [courierId], references: [id])
  warehouse        User?    @relation("WarehousePickups", fields: [warehouseId], references: [id])
  bills            Bill[]
  commissions      Commission[]
  messages         Message[]
}

model Bill {
  id           String   @id @default(uuid())
  pickupId     String
  userId       String
  amount       Float
  status       String   @default("UNPAID") // UNPAID, PAID, OVERDUE, CANCELLED
  dueDate      DateTime
  paidDate     DateTime?
  paymentProof String?  // URL/path to payment proof/receipt
  invoiceNumber String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model Commission {
  id           String   @id @default(uuid())
  pickupId     String
  userId       String
  type         String   // COURIER, AFFILIATE
  amount       Float
  status       String   @default("PENDING") // PENDING, PAID, CANCELLED
  paidDate     DateTime?
  paymentProof String?  // URL/path to payment proof/receipt
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model Message {
  id           String   @id @default(uuid())
  pickupId     String
  senderId     String
  receiverId   String
  content      String
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  sender       User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver     User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Notification {
  id           String   @id @default(uuid())
  userId       String
  title        String
  message      String
  type         String   // PICKUP_REQUEST, PICKUP_ASSIGNED, PICKUP_COMPLETED, PAYMENT_DUE, PAYMENT_RECEIVED, COMMISSION_EARNED, INACTIVE_REMINDER, SYSTEM
  isRead       Boolean  @default(false)
  relatedId    String?
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id])
}

model Settings {
  id                    String   @id @default(uuid())

  // Pricing Settings (Tiered)
  priceTier1Min         Float    @default(1)      // 1 liter
  priceTier1Max         Float    @default(99)     // 99 liters
  priceTier1Rate        Float    @default(6500)   // Rp 6500/liter

  priceTier2Min         Float    @default(100)    // 100 liters
  priceTier2Max         Float    @default(199)    // 199 liters
  priceTier2Rate        Float    @default(7000)   // Rp 7000/liter

  priceTier3Min         Float    @default(200)    // 200+ liters
  priceTier3Rate        Float    @default(7500)   // Rp 7500/liter

  // Courier Commission
  courierCommissionPerLiter Float @default(500)   // Rp 500/liter
  courierDailySalary        Float @default(50000) // Rp 50000/day

  // Affiliate Commission
  affiliateCommissionPerLiter Float @default(200) // Rp 200/liter

  // System Settings
  appName               String   @default("JelantahGO")
  contactPhone          String   @default("")
  contactEmail          String   @default("")
  companyAddress        String   @default("")

  // Notification Settings
  emailTemplate         String   @default("")
  smsTemplate           String   @default("")
  reminderHours         Int      @default(24)     // Hours before reminder

  // Other Settings
  operatingHoursStart   String   @default("08:00")
  operatingHoursEnd     String   @default("17:00")
  serviceArea           String   @default("")     // JSON array of areas
  minimumPickupVolume   Float    @default(40)     // 40 liters minimum

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
