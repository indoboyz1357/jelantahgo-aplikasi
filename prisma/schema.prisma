// Prisma schema for JelantahGO

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String
  name            String
  phone           String
  address         String?
  role            String   @default("CUSTOMER") // ADMIN, CUSTOMER, COURIER, WAREHOUSE
  isActive        Boolean  @default(true)
  referralCode    String   @unique
  referredById    String?
  lastOrderDate   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  referredBy      User?    @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals       User[]   @relation("Referrals")
  
  pickupsAsCustomer  Pickup[]  @relation("CustomerPickups")
  pickupsAsCourier   Pickup[]  @relation("CourierPickups")
  warehouseEntries   Pickup[]  @relation("WarehousePickups")
  bills              Bill[]
  commissions        Commission[]
  notifications      Notification[]
  sentMessages       Message[] @relation("SentMessages")
  receivedMessages   Message[] @relation("ReceivedMessages")
}

model Pickup {
  id               String   @id @default(uuid())
  customerId       String
  courierId        String?
  warehouseId      String?
  status           String   @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED
  scheduledDate    DateTime
  actualDate       DateTime?
  volume           Float    // in liters
  pricePerLiter    Float
  totalPrice       Float
  courierFee       Float    @default(0)
  affiliateFee     Float    @default(0)
  notes            String?
  latitude         Float?
  longitude        Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  customer         User     @relation("CustomerPickups", fields: [customerId], references: [id])
  courier          User?    @relation("CourierPickups", fields: [courierId], references: [id])
  warehouse        User?    @relation("WarehousePickups", fields: [warehouseId], references: [id])
  bills            Bill[]
  commissions      Commission[]
  messages         Message[]
}

model Bill {
  id           String   @id @default(uuid())
  pickupId     String
  userId       String
  amount       Float
  status       String   @default("UNPAID") // UNPAID, PAID, OVERDUE, CANCELLED
  dueDate      DateTime
  paidDate     DateTime?
  invoiceNumber String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model Commission {
  id           String   @id @default(uuid())
  pickupId     String
  userId       String
  type         String   // COURIER, AFFILIATE
  amount       Float
  status       String   @default("PENDING") // PENDING, PAID, CANCELLED
  paidDate     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model Message {
  id           String   @id @default(uuid())
  pickupId     String
  senderId     String
  receiverId   String
  content      String
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  pickup       Pickup   @relation(fields: [pickupId], references: [id])
  sender       User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver     User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Notification {
  id           String   @id @default(uuid())
  userId       String
  title        String
  message      String
  type         String   // PICKUP_REQUEST, PICKUP_ASSIGNED, PICKUP_COMPLETED, PAYMENT_DUE, PAYMENT_RECEIVED, COMMISSION_EARNED, INACTIVE_REMINDER, SYSTEM
  isRead       Boolean  @default(false)
  relatedId    String?
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id])
}
